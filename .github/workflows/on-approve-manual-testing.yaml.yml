name: Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° production ÑĞµÑ€Ğ²ĞµÑ€

on:
    workflow_dispatch:
        inputs:
            release_tag:
                description: 'Ğ¢ĞµĞ³ Ğ´Ğ»Ñ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, v1.0.0)'
                required: true
                type: string
            release_id:
                description: 'Release ID Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…'
                required: true
                type: string

env:
    SERVICE_NAME: ${{ github.event.repository.name }}
    SYSTEM_REPO: loom-system
    TAG_NAME: ${{ github.event.inputs.release_tag }}
    RELEASE_ID: ${{ github.event.inputs.release_id }}

jobs:
    deploy-to-production:
        runs-on: self-hosted

        steps:
            -   name: ğŸ“¥ Checkout ĞºĞ¾Ğ´Ğ°
                uses: actions/checkout@v4
                with:
                    ref: ${{ github.ref }}
                    fetch-depth: 0

            -   name: âœ… Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ²Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ… Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ²
                run: |
                    source .github/scripts/on-approve-manual-testing/validator.sh
                    validate_inputs

            -   name: âš™ï¸ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
                run: |
                    source .github/scripts/on-approve-manual-testing/load_config.sh
                    load_server_config

            -   name: ğŸš€ Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° production ÑĞµÑ€Ğ²ĞµÑ€
                id: deploy_step
                run: |
                    source .github/scripts/on-approve-manual-testing/deploy.sh
                    source .github/scripts/on-approve-manual-testing/release_tg_bot_api.sh
                    start_deploy
                    deploy_to_server

            -   name: ğŸ‰ Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ± ÑƒÑĞ¿ĞµÑ…Ğµ
                if: success()
                run: |
                    source .github/scripts/on-approve-manual-testing/release_tg_bot_api.sh
                    source .github/scripts/on-approve-manual-testing/deploy.sh
                    update_release_status "deployed"
                    
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘       PRODUCTION Ğ”Ğ•ĞŸĞ›ĞĞ™ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•Ğ Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ! ğŸ‰             â•‘"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo ""
                    echo "âœ… Ğ¢ĞµĞ³ ${{ env.TAG_NAME }} Ñ€Ğ°Ğ·Ğ²ĞµÑ€Ğ½ÑƒÑ‚ Ğ½Ğ° production"
                    echo "âœ… ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ñ‹"
                    echo "âœ… Health check Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½"
                    
                    verify_deployment_success

            -   name: âŒ Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
                if: failure()
                run: |
                    source .github/scripts/on-approve-manual-testing/deploy.sh
                    
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘       PRODUCTION Ğ”Ğ•ĞŸĞ›ĞĞ™ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•Ğ Ğ¡ ĞĞ¨Ğ˜Ğ‘ĞšĞĞ™! âŒ           â•‘"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo ""
                    echo "âŒ Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ñ‚ĞµĞ³Ğ° ${{ env.TAG_NAME }} Ğ½Ğµ ÑƒĞ´Ğ°Ğ»ÑÑ"
                    
                    
                    handle_deployment_failure
                    
                    if [ "${{ env.PREVIOUS_TAG_AVAILABLE }}" == "true" ]; then
                      echo "ğŸ”„ Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¾Ñ‚ĞºĞ°Ñ‚ Ğ½Ğ° ${{ env.PREVIOUS_TAG }}"
                    fi
                    echo ""
                    echo "ğŸ” Ğ›Ğ¾Ğ³Ğ¸ Ğ´Ğ»Ñ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ¸:"
                    echo "   GitHub Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    echo "   Ğ¡ĞµÑ€Ğ²ĞµÑ€: /var/log/deployments/production/${{ env.SERVICE_NAME }}/${{ env.TAG_NAME }}.log"
                    echo ""