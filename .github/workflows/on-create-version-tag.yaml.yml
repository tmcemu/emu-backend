name: Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ñ‚ĞµĞ³Ğ° Ğ½Ğ° stage ÑĞµÑ€Ğ²ĞµÑ€

on:
    create:
        tags:
            - 'v*'

env:
    SERVICE_NAME: ${{ github.event.repository.name }}
    SYSTEM_REPO: loom-system
    TAG_NAME: ${{ github.ref_name }}

jobs:
    deploy-to-stage:
        runs-on: self-hosted
        if: github.event.ref_type == 'tag'

        steps:
            -   name: ğŸ“¥ Checkout ĞºĞ¾Ğ´Ğ°
                uses: actions/checkout@v4
                with:
                    ref: ${{ github.ref }}
                    fetch-depth: 0

            -   name: âœ… Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ° Ñ‚ĞµĞ³Ğ°
                run: |
                    echo ""
                    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                    echo "Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ‚ĞµĞ³Ğ°"
                    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                    
                    if [[ ! "${{ env.TAG_NAME }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
                      echo "âŒ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚: ${{ env.TAG_NAME }}"
                      echo "   ĞĞ¶Ğ¸Ğ´Ğ°ĞµÑ‚ÑÑ: v1.0.0"
                      exit 1
                    fi
                    
                    echo "âœ… Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚ĞµĞ½: ${{ env.TAG_NAME }}"
                    TAG_NAME=${GITHUB_REF#refs/tags/}
                    echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
                    echo "::notice title=Ğ¢ĞµĞ³::$TAG_NAME"
                    echo ""

            -   name: âš™ï¸ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
                run: |
                    source .github/scripts/on-create-version-tag/load_config.sh
                    load_server_config

            -   name: ğŸ“ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¾ Ñ€ĞµĞ»Ğ¸Ğ·Ğµ
                run: |
                    source .github/scripts/on-create-version-tag/release_tg_bot_api.sh
                    create_release_record

            -   name: ğŸ—„ï¸ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ±Ğ°Ğ· Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
                continue-on-error: true
                id: refresh_db_step
                run: |
                    source .github/scripts/on-create-version-tag/refresh_db.sh
                    refresh_all_databases

            -   name: ğŸš€ Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° stage ÑĞµÑ€Ğ²ĞµÑ€
                id: deploy_step
                run: |
                    source .github/scripts/on-create-version-tag/release_tg_bot_api.sh
                    source .github/scripts/on-create-version-tag/deploy.sh
                    
                    update_release_status "stage_building"
                    deploy_to_server

            -   name: ğŸ’¾ Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚ĞºĞ°Ñ‚Ğ°
                id: rollback_test_step
                if: steps.deploy_step.outcome == 'success'
                run: |
                    source .github/scripts/on-create-version-tag/release_tg_bot_api.sh
                    source .github/scripts/on-create-version-tag/rollback.sh
                    
                    echo ""
                    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                    echo "ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ³Ğ¾ Ñ‚ĞµĞ³Ğ° Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ° Ğ¾Ñ‚ĞºĞ°Ñ‚Ğ°"
                    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                    
                    PREVIOUS_TAG=$(sshpass -p "$STAGE_PASSWORD" ssh -o StrictHostKeyChecking=no root@$STAGE_HOST -p 22 \
                        "cat /tmp/${{ env.SERVICE_NAME }}_previous_tag.txt 2>/dev/null || echo ''")
                    
                    if [ -z "$PREVIOUS_TAG" ]; then
                      echo "âš ï¸  ĞŸÑ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğ¹ Ñ‚ĞµĞ³ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½"
                      echo "   ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ‚ĞµÑÑ‚ Ğ¾Ñ‚ĞºĞ°Ñ‚Ğ° (Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹)"
                      echo "ROLLBACK_SKIPPED=true" >> $GITHUB_ENV
                    else
                      echo "âœ… ĞĞ°Ğ¹Ğ´ĞµĞ½ Ñ‚ĞµĞ³: $PREVIOUS_TAG"
                      echo "PREVIOUS_TAG=$PREVIOUS_TAG" >> $GITHUB_ENV
                      echo "ROLLBACK_SKIPPED=false" >> $GITHUB_ENV
                    
                      rollback_with_status_tracking
                    fi
                    update_release_status "manual_testing"
                    echo ""

            -   name: ğŸ‰ Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ± ÑƒÑĞ¿ĞµÑ…Ğµ
                if: success()
                run: |
                    source .github/scripts/on-create-version-tag/deploy.sh
                    
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘          ĞŸĞĞ™ĞŸĞ›ĞĞ™Ğ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•Ğ Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ! ğŸ‰                    â•‘"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo ""
                    echo "âœ… Ğ¢ĞµĞ³ ${{ env.TAG_NAME }} Ñ€Ğ°Ğ·Ğ²ĞµÑ€Ğ½ÑƒÑ‚ Ğ½Ğ° stage"
                    echo "âœ… Ğ‘Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹"
                    echo "âœ… ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ¾ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ñ‹"
                    
                    verify_deployment_success
                    
                    if [ "${{ env.ROLLBACK_SKIPPED }}" == "false" ]; then
                      echo "âœ… ĞÑ‚ĞºĞ°Ñ‚ Ğ¿Ñ€Ğ¾Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ (Ğ½Ğ° ${{ env.PREVIOUS_TAG }})"
                    else
                      echo "âš ï¸  ĞÑ‚ĞºĞ°Ñ‚ Ğ½Ğµ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ»ÑÑ (Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹)"
                    fi
                    echo ""
                    echo "ğŸ‘‰ Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ ÑˆĞ°Ğ³: Ğ ÑƒÑ‡Ğ½Ğ¾Ğµ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ"
                    echo "ğŸ‘‰ ĞŸĞ¾ÑĞ»Ğµ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ÑƒÑ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞ½"
                    echo ""

            -   name: âŒ Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
                if: failure()
                run: |
                    source .github/scripts/on-create-version-tag/deploy.sh
                    source .github/scripts/on-create-version-tag/release_tg_bot_api.sh
                    
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘          ĞŸĞĞ™ĞŸĞ›ĞĞ™Ğ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•Ğ Ğ¡ ĞĞ¨Ğ˜Ğ‘ĞšĞĞ™! âŒ                  â•‘"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo ""
                    
                    handle_deployment_failure
                    
                    echo ""
                    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                    echo "ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸"
                    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                    
                    if [ "${{ steps.deploy_step.outcome }}" == "failure" ]; then
                      echo "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ½Ğ° ÑÑ‚Ğ°Ğ¿Ğµ: Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹"
                      update_release_status "stage_building_failed"
                    elif [ "${{ steps.rollback_test_step.outcome }}" == "failure" ]; then
                      echo "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ½Ğ° ÑÑ‚Ğ°Ğ¿Ğµ: Ğ¢ĞµÑÑ‚ Ğ¾Ñ‚ĞºĞ°Ñ‚Ğ°"
                      update_release_status "stage_test_rollback_failed"
                    else
                      echo "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ½Ğ° Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾Ğ¼ ÑÑ‚Ğ°Ğ¿Ğµ"
                      update_release_status "stage_building_failed"
                    fi
                    
                    echo ""
                    echo "ğŸ” Ğ›Ğ¾Ğ³Ğ¸ Ğ´Ğ»Ñ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ¸:"
                    echo "   GitHub Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    echo "   Ğ¡ĞµÑ€Ğ²ĞµÑ€: /var/log/deployments/${{ env.SERVICE_NAME }}/${{ env.TAG_NAME }}.log"
                    echo ""