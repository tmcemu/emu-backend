#!/bin/bash

# ============================================
# ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°Ğ¼Ğ¸ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
# ============================================

refresh_database_table() {
    local service_prefix=$1
    local service_name=$2

    echo ""
    echo "  ğŸ“‹ Ğ¡ĞµÑ€Ğ²Ğ¸Ñ: $service_name"
    echo "  ğŸ”— ĞŸÑ€ĞµÑ„Ğ¸ĞºÑ: $service_prefix"

    local drop_url="${STAGE_DOMAIN}${service_prefix}/table/drop"
    local create_url="${STAGE_DOMAIN}${service_prefix}/table/create"

    # Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†
    echo -n "     ğŸ—‘ï¸  Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†... "
    local drop_response=$(curl -s -w "\n%{http_code}" -X GET "$drop_url")
    local drop_code=$(echo "$drop_response" | tail -n1)
    local drop_body=$(echo "$drop_response" | head -n -1)

    if [ "$drop_code" -ne 200 ]; then
        echo "âš ï¸  HTTP $drop_code"
        echo "     URL: $drop_url"
        echo "     ĞÑ‚Ğ²ĞµÑ‚: $drop_body"
    else
        echo "âœ…"
    fi

    # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†
    echo -n "     ğŸ“ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†... "
    local create_response=$(curl -s -w "\n%{http_code}" -X GET "$create_url")
    local create_code=$(echo "$create_response" | tail -n1)
    local create_body=$(echo "$create_response" | head -n -1)

    if [ "$create_code" -ne 200 ]; then
        echo "âŒ HTTP $create_code"
        echo "     URL: $create_url"
        echo "     ĞÑ‚Ğ²ĞµÑ‚: $create_body"
        return 1
    fi

    echo "âœ…"
    return 0
}

# ============================================
# ĞœĞ°ÑÑĞ¾Ğ²Ğ¾Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ±Ğ°Ğ· Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
# ============================================

refresh_all_databases() {
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ‘ĞĞ— Ğ”ĞĞĞĞ«Ğ¥ Ğ’Ğ¡Ğ•Ğ¥ Ğ¡Ğ•Ğ Ğ’Ğ˜Ğ¡ĞĞ’              â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "ğŸŒ Ğ”Ğ¾Ğ¼ĞµĞ½: $STAGE_DOMAIN"

    # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ² Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ
    local services=(
        "$LOOM_TG_BOT_PREFIX:TG Bot"
        "$LOOM_ACCOUNT_PREFIX:Account"
        "$LOOM_AUTHORIZATION_PREFIX:Authorization"
        "$LOOM_EMPLOYEE_PREFIX:Employee"
        "$LOOM_ORGANIZATION_PREFIX:Organization"
        "$LOOM_CONTENT_PREFIX:Content"
    )

    local total=${#services[@]}
    local failed=0
    local success=0

    echo ""
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° $total ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

    # ĞÑ‚ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ set -e Ğ´Ğ»Ñ Ñ†Ğ¸ĞºĞ»Ğ°
    set +e

    for service_info in "${services[@]}"; do
        IFS=':' read -r prefix name <<< "$service_info"

        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ° Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ Ğ¿Ñ€ĞµÑ„Ğ¸ĞºÑ
        if [ -z "$prefix" ] || [ "$prefix" = ":" ]; then
            echo ""
            echo "  âš ï¸  ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞº: $name (Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ Ğ¿Ñ€ĞµÑ„Ğ¸ĞºÑ)"
            ((failed++))
            continue
        fi

        # Ğ’Ñ‹Ğ·Ğ¾Ğ² Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ñ ÑĞ²Ğ½Ğ¾Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¾Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°
        if refresh_database_table "$prefix" "$name"; then
            ((success++))
        else
            ((failed++))
        fi
    done

    # Ğ’ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾ set -e
    set -e

    # Ğ˜Ñ‚Ğ¾Ğ³Ğ¸
    echo ""
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "Ğ˜Ñ‚Ğ¾Ğ³Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "âœ… Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾:   $success"
    echo "âŒ Ğ¡ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ğ¼Ğ¸: $failed"
    echo "ğŸ“Š Ğ’ÑĞµĞ³Ğ¾:      $total"
    echo ""

    if [ $failed -gt 0 ]; then
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘         ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ‘Ğ” Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ Ğ¡ ĞĞ¨Ğ˜Ğ‘ĞšĞĞœĞ˜                â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        return 1
    fi

    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘         Ğ’Ğ¡Ğ• Ğ‘ĞĞ—Ğ« Ğ”ĞĞĞĞ«Ğ¥ Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ«                 â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    return 0
}